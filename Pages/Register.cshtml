@page
@inject IConfiguration Config
@model BookwormsOnline.Pages.RegisterModel
@{
    ViewData["Title"] = "Register";
}

<div class="row justify-content-center">
    <div class="col-12 col-lg-9 col-xl-8">
        <div class="card bw-card shadow-lg">
            <div class="card-header p-4">
                <h3 class="mb-1">Create your Bookworms account</h3>
                <p class="mb-0 text-muted">Secure registration with JPG-only upload, encryption, and reCAPTCHA.</p>
            </div>

            <div class="card-body p-4">
                <form method="post" id="registerForm" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger py-2" role="alert"></div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="Input.FirstName" class="form-label"></label>
                            <input asp-for="Input.FirstName" class="form-control" placeholder="e.g., John" />
                            <span asp-validation-for="Input.FirstName" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Input.LastName" class="form-label"></label>
                            <input asp-for="Input.LastName" class="form-control" placeholder="e.g., Tan" />
                            <span asp-validation-for="Input.LastName" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Input.Email" class="form-label"></label>
                            <input asp-for="Input.Email" class="form-control" placeholder="name@example.com" />
                            <span asp-validation-for="Input.Email" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Input.MobileNo" class="form-label"></label>
                            <input asp-for="Input.MobileNo" class="form-control" placeholder="8-digit mobile" />
                            <span asp-validation-for="Input.MobileNo" class="text-danger small"></span>
                        </div>

                        <div class="col-12">
                            <label asp-for="Input.BillingAddress" class="form-label"></label>
                            <input asp-for="Input.BillingAddress" class="form-control" placeholder="Billing address" />
                            <span asp-validation-for="Input.BillingAddress" class="text-danger small"></span>
                        </div>

                        <div class="col-12">
                            <label asp-for="Input.ShippingAddress" class="form-label"></label>
                            <input asp-for="Input.ShippingAddress" class="form-control" placeholder="Shipping address (special characters allowed)" />
                            <span asp-validation-for="Input.ShippingAddress" class="text-danger small"></span>
                            <div class="form-text">We allow special characters. Output is safely encoded by Razor.</div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Input.CreditCard" class="form-label"></label>
                            <input asp-for="Input.CreditCard" class="form-control" inputmode="numeric" placeholder="12–19 digits" />
                            <span asp-validation-for="Input.CreditCard" class="text-danger small"></span>
                            <div class="form-text">Stored encrypted in the database.</div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Input.Photo" class="form-label">Profile Photo (JPG only)</label>
                            <input asp-for="Input.Photo" type="file" class="form-control" accept=".jpg,.jpeg,image/jpeg" />
                            <span asp-validation-for="Input.Photo" class="text-danger small"></span>
                            <div class="form-text">Max size enforced server-side.</div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Input.Password" class="form-label"></label>
                            <input asp-for="Input.Password" class="form-control" id="pw" placeholder="Strong password" />
                            <span asp-validation-for="Input.Password" class="text-danger small"></span>

                            <div class="mt-2">
                                <div class="progress" style="height: 6px;">
                                    <div id="pwBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small id="pwStrengthText" class="text-muted">Strength: —</small>
                                    <small id="pwRulesText" class="text-muted"></small>
                                </div>
                            </div>
                        </div>


                        <div class="col-md-6">
                            <label asp-for="Input.ConfirmPassword" class="form-label"></label>
                            <input asp-for="Input.ConfirmPassword" type="password" class="form-control"
                                   placeholder="Repeat password" autocomplete="new-password" />
                            <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- reCAPTCHA v3 token -->
                    <input type="hidden" asp-for="Input.RecaptchaToken" id="recaptchaToken" />
                    <span asp-validation-for="Input.RecaptchaToken" class="text-danger small"></span>

                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary px-4">Create Account</button>
                        <a class="btn btn-outline-light" asp-page="/Login">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>

        <p class="text-muted small mt-3 mb-0">
            Protected by Google reCAPTCHA v3.
        </p>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="https://www.google.com/recaptcha/api.js?render=@Config["Recaptcha:SiteKey"]"></script>

    <script>
        const pw = document.getElementById("pw");
        const pwBar = document.getElementById("pwBar");
        const pwStrengthText = document.getElementById("pwStrengthText");
        const pwRulesText = document.getElementById("pwRulesText");

        function scorePassword(p) {
            let score = 0;
            const rules = {
                len: p.length >= 12,
                upper: /[A-Z]/.test(p),
                lower: /[a-z]/.test(p),
                digit: /\d/.test(p),
                special: /[^A-Za-z0-9]/.test(p)
            };

            // Score based on your actual policy (0..5)
            score += rules.len ? 1 : 0;
            score += rules.upper ? 1 : 0;
            score += rules.lower ? 1 : 0;
            score += rules.digit ? 1 : 0;
            score += rules.special ? 1 : 0;

            return { score, rules };
        }

        function renderStrength(p) {
            const { score, rules } = scorePassword(p);

            // Map score to label + percent
            let label = "Weak";
            let percent = 20;

            if (score <= 1) { label = "Very weak"; percent = 10; }
            else if (score === 2) { label = "Weak"; percent = 25; }
            else if (score === 3) { label = "Fair"; percent = 50; }
            else if (score === 4) { label = "Strong"; percent = 75; }
            else if (score === 5) { label = "Very strong"; percent = 100; }

            pwBar.style.width = percent + "%";
            pwStrengthText.textContent = `Strength: ${p.length === 0 ? "—" : label}`;

            // Show which rules are missing (minimal)
            const missing = [];
            if (!rules.len) missing.push("12+ chars");
            if (!rules.upper) missing.push("uppercase");
            if (!rules.lower) missing.push("lowercase");
            if (!rules.digit) missing.push("number");
            if (!rules.special) missing.push("special");

            pwRulesText.textContent = missing.length ? `Missing: ${missing.join(", ")}` : "Meets policy ✓";
        }

        pw.addEventListener("input", () => renderStrength(pw.value));
        renderStrength("");
    </script>
    <script>
        const form = document.getElementById("registerForm");

        form.addEventListener("submit", function (e) {
            e.preventDefault();

            grecaptcha.ready(function () {
                grecaptcha.execute("@Config["Recaptcha:SiteKey"]", { action: "register" })
                    .then(function (token) {
                        document.getElementById("recaptchaToken").value = token;
                        form.submit();
                    });
            });
        });
    </script>


}
